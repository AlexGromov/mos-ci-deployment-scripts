- job:
    parameters:
      - string:
          name: MAGNET_LINK
          default: 'magnet:?xt=urn:btih:9d59953417e0c2608f8fa0ffe43ceac00967708f&dn=MirantisOpenStack-6.1.iso&tr=http%3A%2F%2Ftracker01-bud.infra.mirantis.net%3A8080%2Fannounce&tr=http%3A%2F%2Ftracker01-scc.infra.mirantis.net%3A8080%2Fannounce&tr=http%3A%2F%2Ftracker01-msk.infra.mirantis.net%3A8080%2Fannounce&ws=http%3A%2F%2Fvault.infra.mirantis.net%2FMirantisOpenStack-6.1.iso'
          description: 'ISO magnet link'
      - string:
          name: ISO_DIR
          default: "/var/www/fuelweb-iso"
      - string:
          name: SNAPSHOT_NAME
      - string:
          name: TEST_TYPE
      - string:
          name: ERASE_PREV_ENV
          default: "FALSE"
      - string:
          name: SEGMENT_TYPE
      - string:
          name: DVR_ENABLE
          default: "FALSE"
      - string:
          name: L3_HA_ENABLE
          default: "FALSE"
      - string:
          name: L2_POP_ENABLE
          default: "FALSE"
      - string:
          name: CEPH_ENABLE
          default: "FALSE"
      - string:
          name: RADOS_ENABLE
          default: "FALSE"
      - string:
          name: SAHARA_ENABLE
          default: "FALSE"
      - string:
          name: MURANO_ENABLE
          default: "FALSE"
      - string:
          name: MONGO_ENABLE
          default: "FALSE"
      - string:
          name: CEILOMETER_ENABLE
          default: "FALSE"
      - string:
          name: DISABLE_SSL
          default: "TRUE"
      - string:
          name: FUEL_DEV_VER
          default: "2.9.16"
      - string:
          name: FUEL_QA_VER
          default: "stable/6.1"
      - string:
          name: MASTER_IS_CENTOS7
          default: "FALSE"
      - string:
          name: ENV_CHANGER

    name: create_param_environment_maintenance_6_1
    builders:
        - shell: |
            echo `hostname`
            wget -O /tmp/python-seed-client.deb http://mirror.fuel-infra.org/devops/ubuntu/all/python-seed-client_0.17-ubuntu55_all.deb  
            sudo apt-get -y -f install
            sudo dpkg -i /tmp/python-seed-client.deb
            sudo apt-get -y -f install
            echo $PATH
            if [ ! -d ${ISO_DIR} ];
            then
                sudo mkdir -p ${ISO_DIR}
            fi
            ISO_PATH=$(sudo seedclient-wrapper -d -m "${MAGNET_LINK}" -v --force-set-symlink -o "${ISO_DIR}")
            ISO_NAME=`ls "$ISO_DIR"`
            ENV_NAME=MOS_CI_"$ISO_NAME"
            if [ -n "$ENV_CHANGER" ];
            then
                ENV_NAME="$ENV_NAME""$ENV_CHANGER"
            fi
            set +e
            #git clone https://github.com/openstack/fuel-devops.git
            #cd fuel-devops
            virtualenv venv
            . venv/bin/activate
            pip install git+https://github.com/openstack/fuel-devops.git@${FUEL_DEV_VER} --upgrade
            #pip install setuptools --upgrade
            #pip install test-requirements.txt
            #python setup.py install
            UT=`dos.py snapshot-list "$ENV_NAME" || true`
            OUT=`echo "$UT" | grep "$SNAPSHOT_NAME"`
            deactivate
            set -e
            if [ -n "$OUT" ];
            then
                exit 0
            else
                export ISO_PATH="$ISO_DIR"/"$ISO_NAME"
                export ENV_NAME="$ENV_NAME"
                export ERASE_PREV_ENV="$ERASE_PREV_ENV"
                export SEGMENT_TYPE="$SEGMENT_TYPE"
                export DVR_ENABLE="$DVR_ENABLE"
                export L3_HA_ENABLE="$L3_HA_ENABLE"
                export L2_POP_ENABLE="$L2_POP_ENABLE"
                export CEPH_ENABLE="$CEPH_ENABLE"
                export RADOS_ENABLE="$RADOS_ENABLE"
                export SAHARA_ENABLE="$SAHARA_ENABLE"
                export MURANO_ENABLE="$MURANO_ENABLE"
                export MONGO_ENABLE="$MONGO_ENABLE"
                export CEILOMETER_ENABLE="$CEILOMETER_ENABLE"
                export DISABLE_SSL="$DISABLE_SSL"
                export FUEL_DEV_VER="$FUEL_DEV_VER"
                export FUEL_QA_VER="$FUEL_QA_VER"
                ./deploy_env.sh
            fi
    project-type: freestyle
    node: maintenance
    defaults: global
    scm: 
       - mos-ci-deployment-scripts
    description: 'Create environment with parameters, specified by PARAM string.'
    disabled: false
    display-name: 'Create Parameterized Environment (6.1 maintenance)'
    concurrent: true
    browser: githubweb
    retry-count: 3
    logrotate:
      daysToKeep: 14
      numToKeep: 50
      artifactDaysToKeep: -1
      artifactNumToKeep: -1
    publishers:
      - email:
          recipients: mlaptev@mirantis.com