- test_run_defaults: &test_run_defaults
    name: test_run_defaults
    current-parameters: true
    kill-phase-on: NEVER
    property-file: "$ENV_INJECT_PATH"

#
# Template used to define the tests validating the StackLight plugins at
# periodic intervals (eg daily)
#
- job-template:
    name: '{version}.stacklight.{plugin_branch}.runner'
    node: '{node_label}'
    project-type: multijob

#    triggers:
#      - timed: '{timer}'

    description: "Run all required StackLight tests"

    builders:
      - clear-property-file
      - multijob:
          name: 'Erase old envs on all slaves'
          condition: COMPLETED
          projects:
            - name: 'erase_old_envs.stacklight.all_slaves'
              current-parameters: true
              kill-phase-on: NEVER
              property-file: "$ENV_INJECT_PATH"

      - multijob:
          name: 'Build StackLight plugins on all slaves'
          condition: SUCCESSFUL
          projects:
            - name: '9.x.build_stacklight.master.all_slaves'
              current-parameters: true
              property-file: "$ENV_INJECT_PATH"
      - inject:
          properties-file: "$ENV_INJECT_PATH"
      - update-snapshot-variables
      - multijob:
          name: 'Run the system tests'
          condition: COMPLETED
          timeout: '480'

          projects:
            - name: '{version}.stacklight.{plugin_branch}.prepare_slaves_3_single_tests'
              <<: *test_run_defaults

            - name: '{version}.stacklight.{plugin_branch}.prepare_slaves_5_single_tests'
              <<: *test_run_defaults

            - name: '{version}.stacklight.{plugin_branch}.prepare_slaves_9_single_tests'
              <<: *test_run_defaults

            - name: '{version}.stacklight.{plugin_branch}.deploy_standalone_backends'
              <<: *test_run_defaults

            - name: '{version}.stacklight.{plugin_branch}.detached_plugins'
              <<: *test_run_defaults

            - name: '{version}.stacklight.{plugin_branch}.network_templates'
              <<: *test_run_defaults

            - name: '{version}.stacklight.{plugin_branch}.ldap'
              <<: *test_run_defaults

            - name: '{version}.stacklight.{plugin_branch}.failover'
              <<: *test_run_defaults

    parameters:
      - string:
          name: ENV_PREFIX
          default: '{version}.stacklight.{plugin_branch}'
          description: 'Environment prefix used for systest'
      - string:
          name: ENV_INJECT_PATH
          default: '{env_inject_path}'
          description: 'File with common vars to inject for some jobs'
      - string:
          name: PLUGINS_DIR
          default: '{plugins_dir}'
          description: 'The directory where the plugins have been checked out'

    wrappers:
      - timeout:
          fail: false
          timeout: 360
          write-description: false
